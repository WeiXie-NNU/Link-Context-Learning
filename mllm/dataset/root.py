from typing import Dict, Any, List, Tuple

from PIL import Image
from mmengine import DATASETS, TRANSFORMS, METRICS, FUNCTIONS, Registry

from ..conversation import Conversation

IMAGE_PLACEHOLDER = '<image>'
BOXES_PLACEHOLDER = '<boxes>'
EXPR_PLACEHOLDER = '<expr>'
OBJS_PLACEHOLDER = '<objs>'
QUESTION_PLACEHOLDER = '<question>'
POINTS_PLACEHOLDER = '<points>'
# processor
BOXES_PROCESSOR = Registry('Processor for Boxes')
MAPPING_DICT = {"1": 0, "2": 1, "3": 2, "4": 3, "5": 4, "6": 5, "7": 6, "8": 7, "9": 8, "10": 9, "11": 10, "12": 11, "13": 12, "14": 13, "15": 14, "16": 15, "17": 16, "18": 17, "19": 18, "22": 19, "23": 20, "24": 21, "25": 22, "26": 23, "27": 24, "28": 25, "29": 26, "30": 27, "31": 28, "32": 29, "34": 30, "35": 31, "36": 32, "37": 33, "38": 34, "39": 35, "40": 36, "41": 37, "42": 38, "44": 39, "45": 40, "46": 41, "47": 42, "48": 43, "49": 44, "51": 45, "54": 46, "55": 47, "56": 48, "57": 49, "58": 50, "59": 51, "60": 52, "61": 53, "62": 54, "63": 55, "64": 56, "66": 57, "67": 58, "68": 59, "69": 60, "70": 61, "71": 62, "72": 63, "73": 64, "75": 65, "76": 66, "77": 67, "78": 68, "79": 69, "80": 70, "81": 71, "82": 72, "83": 73, "84": 74, "85": 75, "86": 76, "87": 77, "88": 78, "89": 79, "91": 80, "92": 81, "93": 82, "94": 83, "95": 84, "96": 85, "99": 86, "101": 87, "103": 88, "104": 89, "105": 90, "106": 91, "107": 92, "108": 93, "109": 94, "110": 95, "111": 96, "112": 97, "114": 98, "115": 99, "116": 100, "117": 101, "118": 102, "119": 103, "120": 104, "121": 105, "122": 106, "123": 107, "124": 108, "125": 109, "126": 110, "127": 111, "129": 112, "130": 113, "131": 114, "132": 115, "133": 116, "134": 117, "135": 118, "136": 119, "137": 120, "138": 121, "139": 122, "140": 123, "141": 124, "142": 125, "143": 126, "144": 127, "145": 128, "146": 129, "147": 130, "149": 131, "150": 132, "151": 133, "152": 134, "153": 135, "155": 136, "156": 137, "157": 138, "158": 139, "159": 140, "160": 141, "161": 142, "162": 143, "163": 144, "164": 145, "165": 146, "166": 147, "167": 148, "168": 149, "169": 150, "171": 151, "172": 152, "173": 153, "174": 154, "176": 155, "177": 156, "178": 157, "180": 158, "181": 159, "182": 160, "183": 161, "184": 162, "185": 163, "186": 164, "187": 165, "188": 166, "189": 167, "190": 168, "191": 169, "192": 170, "193": 171, "194": 172, "195": 173, "196": 174, "197": 175, "198": 176, "200": 177, "201": 178, "202": 179, "203": 180, "204": 181, "206": 182, "207": 183, "208": 184, "209": 185, "210": 186, "211": 187, "212": 188, "213": 189, "214": 190, "215": 191, "216": 192, "218": 193, "219": 194, "220": 195, "221": 196, "222": 197, "224": 198, "226": 199, "227": 200, "228": 201, "229": 202, "230": 203, "231": 204, "233": 205, "234": 206, "235": 207, "236": 208, "237": 209, "238": 210, "240": 211, "241": 212, "242": 213, "243": 214, "246": 215, "247": 216, "248": 217, "249": 218, "250": 219, "251": 220, "252": 221, "253": 222, "254": 223, "255": 224, "256": 225, "257": 226, "258": 227, "259": 228, "261": 229, "262": 230, "264": 231, "265": 232, "266": 233, "267": 234, "269": 235, "270": 236, "271": 237, "272": 238, "274": 239, "275": 240, "276": 241, "277": 242, "278": 243, "279": 244, "280": 245, "281": 246, "282": 247, "283": 248, "284": 249, "285": 250, "286": 251, "287": 252, "288": 253, "289": 254, "290": 255, "291": 256, "292": 257, "293": 258, "294": 259, "295": 260, "297": 261, "298": 262, "299": 263, "301": 264, "303": 265, "304": 266, "305": 267, "308": 268, "309": 269, "310": 270, "312": 271, "314": 272, "315": 273, "316": 274, "317": 275, "318": 276, "319": 277, "320": 278, "323": 279, "324": 280, "325": 281, "326": 282, "327": 283, "328": 284, "329": 285, "330": 286, "331": 287, "332": 288, "334": 289, "335": 290, "336": 291, "337": 292, "339": 293, "340": 294, "341": 295, "342": 296, "343": 297, "344": 298, "345": 299, "347": 300, "348": 301, "349": 302, "350": 303, "351": 304, "352": 305, "353": 306, "355": 307, "356": 308, "357": 309, "358": 310, "359": 311, "361": 312, "362": 313, "363": 314, "365": 315, "366": 316, "367": 317, "368": 318, "369": 319, "370": 320, "371": 321, "372": 322, "373": 323, "374": 324, "376": 325, "377": 326, "378": 327, "379": 328, "380": 329, "381": 330, "382": 331, "383": 332, "384": 333, "385": 334, "387": 335, "388": 336, "389": 337, "390": 338, "391": 339, "392": 340, "393": 341, "394": 342, "395": 343, "396": 344, "397": 345, "398": 346, "400": 347, "401": 348, "402": 349, "403": 350, "404": 351, "405": 352, "406": 353, "407": 354, "408": 355, "409": 356, "411": 357, "412": 358, "413": 359, "414": 360, "415": 361, "416": 362, "418": 363, "419": 364, "420": 365, "421": 366, "422": 367, "423": 368, "424": 369, "425": 370, "426": 371, "427": 372, "428": 373, "429": 374, "430": 375, "432": 376, "433": 377, "434": 378, "435": 379, "436": 380, "437": 381, "438": 382, "439": 383, "440": 384, "441": 385, "442": 386, "443": 387, "444": 388, "445": 389, "446": 390, "447": 391, "448": 392, "450": 393, "451": 394, "452": 395, "453": 396, "454": 397, "455": 398, "459": 399, "460": 400, "461": 401, "462": 402, "464": 403, "465": 404, "466": 405, "467": 406, "468": 407, "470": 408, "472": 409, "473": 410, "474": 411, "476": 412, "477": 413, "478": 414, "479": 415, "480": 416, "481": 417, "482": 418, "483": 419, "484": 420, "485": 421, "486": 422, "487": 423, "488": 424, "489": 425, "491": 426, "492": 427, "493": 428, "494": 429, "495": 430, "496": 431, "497": 432, "498": 433, "499": 434, "500": 435, "501": 436, "502": 437, "503": 438, "504": 439, "505": 440, "506": 441, "507": 442, "508": 443, "509": 444, "510": 445, "511": 446, "512": 447, "513": 448, "514": 449, "515": 450, "516": 451, "517": 452, "518": 453, "519": 454, "520": 455, "521": 456, "523": 457, "524": 458, "525": 459, "526": 460, "527": 461, "528": 462, "529": 463, "530": 464, "531": 465, "532": 466, "533": 467, "534": 468, "535": 469, "536": 470, "537": 471, "538": 472, "539": 473, "540": 474, "541": 475, "542": 476, "543": 477, "544": 478, "545": 479, "546": 480, "547": 481, "548": 482, "549": 483, "550": 484, "551": 485, "552": 486, "553": 487, "554": 488, "555": 489, "557": 490, "558": 491, "559": 492, "560": 493, "561": 494, "562": 495, "563": 496, "564": 497, "566": 498, "567": 499, "568": 500, "569": 501, "570": 502, "571": 503, "572": 504, "573": 505, "574": 506, "575": 507, "576": 508, "577": 509, "578": 510, "579": 511, "580": 512, "581": 513, "582": 514, "583": 515, "584": 516, "585": 517, "586": 518, "587": 519, "588": 520, "589": 521, "590": 522, "591": 523, "592": 524, "593": 525, "594": 526, "595": 527, "596": 528, "597": 529, "598": 530, "599": 531, "600": 532, "601": 533, "602": 534, "603": 535, "604": 536, "606": 537, "607": 538, "608": 539, "609": 540, "610": 541, "611": 542, "612": 543, "613": 544, "614": 545, "615": 546, "616": 547, "617": 548, "618": 549, "619": 550, "620": 551, "621": 552, "622": 553, "624": 554, "625": 555, "626": 556, "627": 557, "628": 558, "629": 559, "630": 560, "631": 561, "632": 562, "633": 563, "634": 564, "635": 565, "636": 566, "637": 567, "638": 568, "639": 569, "640": 570, "641": 571, "642": 572, "643": 573, "644": 574, "645": 575, "646": 576, "647": 577, "650": 578, "652": 579, "653": 580, "654": 581, "655": 582, "657": 583, "658": 584, "659": 585, "660": 586, "661": 587, "664": 588, "665": 589, "666": 590, "667": 591, "668": 592, "669": 593, "670": 594, "671": 595, "672": 596, "673": 597, "674": 598, "675": 599, "676": 600, "677": 601, "678": 602, "679": 603, "680": 604, "681": 605, "682": 606, "683": 607, "684": 608, "685": 609, "686": 610, "687": 611, "688": 612, "689": 613, "690": 614, "692": 615, "693": 616, "694": 617, "695": 618, "696": 619, "697": 620, "698": 621, "699": 622, "700": 623, "701": 624, "702": 625, "704": 626, "706": 627, "707": 628, "708": 629, "709": 630, "710": 631, "711": 632, "713": 633, "714": 634, "715": 635, "716": 636, "717": 637, "718": 638, "719": 639, "720": 640, "721": 641, "722": 642, "723": 643, "724": 644, "725": 645, "726": 646, "727": 647, "728": 648, "729": 649, "730": 650, "731": 651, "732": 652, "733": 653, "734": 654, "737": 655, "738": 656, "739": 657, "741": 658, "742": 659, "743": 660, "744": 661, "745": 662, "746": 663, "748": 664, "749": 665, "751": 666, "753": 667, "754": 668, "755": 669, "756": 670, "757": 671, "758": 672, "759": 673, "760": 674, "761": 675, "762": 676, "763": 677, "764": 678, "765": 679, "766": 680, "767": 681, "768": 682, "769": 683, "770": 684, "771": 685, "772": 686, "773": 687, "774": 688, "775": 689, "776": 690, "777": 691, "778": 692, "779": 693, "780": 694, "781": 695, "782": 696, "783": 697, "784": 698, "785": 699, "786": 700, "787": 701, "788": 702, "790": 703, "792": 704, "793": 705, "794": 706, "795": 707, "797": 708, "798": 709, "799": 710, "800": 711, "801": 712, "802": 713, "803": 714, "804": 715, "805": 716, "806": 717, "807": 718, "808": 719, "809": 720, "810": 721, "811": 722, "812": 723, "813": 724, "814": 725, "815": 726, "817": 727, "818": 728, "819": 729, "820": 730, "821": 731, "822": 732, "823": 733, "824": 734, "825": 735, "826": 736, "827": 737, "828": 738, "829": 739, "830": 740, "831": 741, "832": 742, "833": 743, "834": 744, "835": 745, "836": 746, "837": 747, "838": 748, "839": 749, "840": 750, "841": 751, "842": 752, "843": 753, "844": 754, "845": 755, "846": 756, "847": 757, "848": 758, "849": 759, "850": 760, "851": 761, "852": 762, "853": 763, "854": 764, "855": 765, "856": 766, "857": 767, "858": 768, "859": 769, "860": 770, "861": 771, "862": 772, "863": 773, "864": 774, "865": 775, "867": 776, "868": 777, "869": 778, "870": 779, "871": 780, "872": 781, "873": 782, "874": 783, "875": 784, "876": 785, "877": 786, "878": 787, "879": 788, "880": 789, "881": 790, "882": 791, "883": 792, "884": 793, "885": 794, "886": 795, "887": 796, "888": 797, "889": 798, "890": 799, "891": 800, "892": 801, "893": 802, "894": 803, "895": 804, "896": 805, "898": 806, "899": 807, "900": 808, "901": 809, "902": 810, "903": 811, "904": 812, "906": 813, "907": 814, "908": 815, "909": 816, "910": 817, "911": 818, "912": 819, "913": 820, "914": 821, "915": 822, "916": 823, "917": 824, "918": 825, "920": 826, "921": 827, "922": 828, "924": 829, "925": 830, "926": 831, "927": 832, "928": 833, "929": 834, "930": 835, "931": 836, "932": 837, "933": 838, "934": 839, "935": 840, "936": 841, "938": 842, "939": 843, "940": 844, "941": 845, "944": 846, "945": 847, "946": 848, "947": 849, "948": 850, "950": 851, "951": 852, "952": 853, "953": 854, "954": 855, "955": 856, "956": 857, "958": 858, "959": 859, "960": 860, "961": 861, "962": 862, "963": 863, "964": 864, "965": 865, "966": 866, "967": 867, "968": 868, "969": 869, "970": 870, "971": 871, "972": 872, "973": 873, "974": 874, "975": 875, "976": 876, "977": 877, "978": 878, "979": 879, "980": 880, "981": 881, "982": 882, "983": 883, "985": 884, "986": 885, "987": 886, "988": 887, "989": 888, "990": 889, "991": 890, "992": 891, "993": 892, "994": 893, "995": 894, "996": 895, "997": 896, "998": 897, "999": 898, "1000": 899}

# only for static type checking
class BaseConvProcessFunc:
    def __call__(
            self,
            raw_conv: List[Dict[str, Any]],
            preprocessor: Dict[str, Any],
            conv_template: Conversation,
    ) -> List[Dict[str, Any]]:
        raise NotImplementedError


class BaseTargetProcessFunc:
    def __call__(
            self,
            raw_conv: List[Dict[str, Any]],
            target: Dict[str, Any],
            preprocessor: Dict[str, Any],
    ) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        raise NotImplementedError


class BaseTextProcessFunc:
    def __call__(
            self,
            conv: Conversation,
            preprocessor: Dict[str, Any],
            mode: str,
            **tokenize_kwargs,
    ) -> Dict[str, Any]:
        raise NotImplementedError


class BaseImageProcessFunc:
    def __call__(
            self,
            image: Image.Image,
            preprocessor: Dict[str, Any],
    ) -> Dict[str, Any]:
        raise NotImplementedError


__all__ = [
    'IMAGE_PLACEHOLDER', 'BOXES_PLACEHOLDER', 'EXPR_PLACEHOLDER', 'OBJS_PLACEHOLDER', 'QUESTION_PLACEHOLDER', 'POINTS_PLACEHOLDER',
    'FUNCTIONS',
    'DATASETS',
    'TRANSFORMS',
    'METRICS',
    'BOXES_PROCESSOR',
    'BaseConvProcessFunc', 'BaseTargetProcessFunc', 'BaseTextProcessFunc', 'BaseImageProcessFunc',
]
